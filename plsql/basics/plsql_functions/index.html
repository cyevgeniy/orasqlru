<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/superkube.min.css><link rel=stylesheet href=/css/main.css><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push(101305633)</script><script async src=//static.getclicky.com/js></script><title>Учебник Oracle SQL, PL/SQL | Функции в PL/SQL</title></head><body><div class="navbar bg-dark mb-10"><div class="navbar-container container edges centered"><div class=navbar-brand><a href=/ class=brand>Orasql.ru</a></div><div class="navbar-nav ml-6"><nav class="nav nav-light nav-semibold"><ul class=nav-list><li class=nav-item><a href=/book/ class=nav-link>Книга</a></li></ul></nav><nav class="nav nav-light nav-semibold"><ul class=nav-list><li class=nav-item><a href=https://github.com/cyevgeniy/orasqlru class=nav-link>Github</a></li></ul></nav></div></div></div><main class="layout layout-doc pt-8 pb-10"><div class="layout-container container edges centered flex-layout"><div class="layout-sidebar flex-sidebar hidden-sm pr-12 pr-off-sm mb-8-sm"><nav class="menu menu-semibold menu-muted menu-medium"><h5 class=heading-micro>Введение</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/intro/sqlintro/ class=menu-link>Введение в SQL</a></li><li class=menu-item><a href=http://orasql.ru/sql/intro/ddldml/ class=menu-link>DML, DDL</a></li><li class=menu-item><a href=http://orasql.ru/sql/intro/sqlcloud/ class=menu-link>Выполнение SQL. Облачные сервисы</a></li><li class=menu-item><a href=http://orasql.ru/sql/intro/instruments/ class=menu-link>Инструменты для работы с БД Oracle</a></li><li class=menu-item><a href=http://orasql.ru/sql/intro/links/ class=menu-link>Ссылки на полезные ресурсы</a></li></ul><h5 class=heading-micro>Основы</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/basics/tables/ class=menu-link>Таблицы</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/maintypes/ class=menu-link>Основные типы данных</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/selectstruct/ class=menu-link>Пример SELECT запроса</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/scripts/ class=menu-link>Написание SQL- кода</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/orderby/ class=menu-link>Сортировка результатов. Order by</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/comparison/ class=menu-link>Оператор WHERE. Операторы сравнения</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/andor/ class=menu-link>Проверка нескольких условий. AND, OR</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/isnull/ class=menu-link>Проверка значения на NULL</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/innotin/ class=menu-link>IN, NOT IN</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/between/ class=menu-link>Вхождение в диапазон. BETWEEN. NOT BETWEEN</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/joins/ class=menu-link>Соединения таблиц</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/recursive/ class=menu-link>Древовидные структуры данных. Рекурсивные запросы</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/subqueries/ class=menu-link>Подзапросы в Oracle</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/exists/ class=menu-link>Exists. Наличие строк в подзапросе</a></li><li class=menu-item><a href=http://orasql.ru/sql/basics/with/ class=menu-link>Subquery factoring. WITH</a></li></ul><h5 class=heading-micro>Работа с множествами</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/sets/unions/ class=menu-link>Объединение. UNION</a></li><li class=menu-item><a href=http://orasql.ru/sql/sets/minus/ class=menu-link>Разница запросов. MINUS</a></li><li class=menu-item><a href=http://orasql.ru/sql/sets/intersect/ class=menu-link>Пересечение запросов</a></li><li class=menu-item><a href=http://orasql.ru/sql/sets/sets/ class=menu-link>Работа с множествами. Общая информация</a></li></ul><h5 class=heading-micro>Стандарные функции</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/standfunc/stringfunctions/ class=menu-link>Функции для работы со строками</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/nullfunctions/ class=menu-link>Функции для работы с NULL</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/conditional/ class=menu-link>Условные функции</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/bit/ class=menu-link>Битовые операции</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/aggregation/ class=menu-link>Агрегирующие функции</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/datefunctions/ class=menu-link>Работа с датами в Oracle</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/analytics/ class=menu-link>Аналитические функции</a></li><li class=menu-item><a href=http://orasql.ru/sql/standfunc/distinct/ class=menu-link>Distinct. Удаление дубликатов</a></li></ul><h5 class=heading-micro>DML. Изменение данных и структуры БД</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/dml/dmlinsert/ class=menu-link>Оператор INSERT</a></li><li class=menu-item><a href=http://orasql.ru/sql/dml/dmlupdate/ class=menu-link>Изменение данных. UPDATE</a></li><li class=menu-item><a href=http://orasql.ru/sql/dml/dmldelete/ class=menu-link>Удаление данных. DELETE</a></li><li class=menu-item><a href=http://orasql.ru/sql/dml/dmlmerge/ class=menu-link>Слияние данных. MERGE</a></li><li class=menu-item><a href=http://orasql.ru/sql/dml/dmlaltertable/ class=menu-link>Изменение структуры таблицы. ALTER TABLE</a></li></ul><h5 class=heading-micro>Объекты БД</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/primarykeys/ class=menu-link>Первичные ключи</a></li><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/foreignkeys/ class=menu-link>Внешние ключи</a></li><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/uniquekeys/ class=menu-link>Уникальные ключи</a></li><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/views/ class=menu-link>Представления</a></li><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/indexes/ class=menu-link>Индексы</a></li><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/virtualcolumns/ class=menu-link>Виртуальные колонки</a></li><li class=menu-item><a href=http://orasql.ru/sql/dbobjects/pseudocolumns/ class=menu-link>Псевдостолбцы в Oracle</a></li></ul><h5 class=heading-micro>Транзакции</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/sql/transactions/transactions/ class=menu-link>Транзакции в Oracle</a></li></ul><h5 class=heading-micro>Введение</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/plsql/intro/plsql_intro/ class=menu-link>Что такое PL/SQL</a></li><li class=menu-item><a href=http://orasql.ru/plsql/intro/plsql_whentouse/ class=menu-link>Когда использовать PL/SQL</a></li></ul><h5 class=heading-micro>Основы PL/SQL</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_anonymous_blocks/ class=menu-link>Анонимные блоки</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_blocks/ class=menu-link>Вложенные и именованные блоки</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_first_program/ class=menu-link>Первая программа на PL/SQL</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_dbms_put_line/ class=menu-link>DBMS_OUTPUT.PUT_LINE. Вывод на экран</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_simpletypes/ class=menu-link>Переменные, константы. Простые типы данных</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_ifelse/ class=menu-link>Условное ветвление. If...else...elsif</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_schema/ class=menu-link>Схема БД. Её объекты</a></li><li class="menu-item active"><a href=http://orasql.ru/plsql/basics/plsql_functions/ class=menu-link>Функции в PL/SQL</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/plsql_procedures/ class=menu-link>Процедуры в PL/SQL</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/context/ class=menu-link>Взаимодействие PL/SQL и SQL. Переключение контекста</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/packages/ class=menu-link>Пакеты</a></li><li class=menu-item><a href=http://orasql.ru/plsql/basics/loops/ class=menu-link>Циклы в PL/SQL</a></li></ul><h5 class=heading-micro>Обработка ошибок</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/plsql/exc/basics/ class=menu-link>Обработка ошибок в PL/SQL</a></li></ul><h5 class=heading-micro>Взаимодействие с данными</h5><ul class=menu-list><li class=menu-item><a href=http://orasql.ru/plsql/sql/selectinto/ class=menu-link>Взаимодействие SQL и PL/SQL</a></li></ul></nav></div><div class="layout-content flex-content"><div id=container class="container-medium edges centered"><div class="doc-head mb-4 container-10"><h5 class="heading-micro heading-muted">Основы PL/SQL</h5><h1 class="heading-huge heading-heavy">Функции в PL/SQL</h1></div><div class="doc-toc mt-6 mb-6"><nav class="menu menu-underline menu-medium menu-numbered"><ul class=menu-list><li class=menu-item><a href=#%d0%ba%d0%b0%d0%ba%d1%83%d1%8e-%d0%bf%d1%80%d0%be%d0%b1%d0%bb%d0%b5%d0%bc%d1%83-%d0%bf%d0%be%d0%bc%d0%be%d0%b3%d0%b0%d1%8e%d1%82-%d1%80%d0%b5%d1%88%d0%b8%d1%82%d1%8c-%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8 class=menu-link>Какую проблему помогают решить функции</a></li><li class=menu-item><a href=#%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%80-%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d1%8f-%d0%bf%d1%80%d0%be%d1%81%d1%82%d0%be%d0%b9-%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8 class=menu-link>Пример создания простой функции</a></li><li class=menu-item><a href=#%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8-%d1%81-%d0%be%d1%88%d0%b8%d0%b1%d0%ba%d0%b0%d0%bc%d0%b8-%d0%b2%d1%81%d0%b5-%d1%80%d0%b0%d0%b2%d0%bd%d0%be-%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d1%8e%d1%82%d1%81%d1%8f class=menu-link>Функции с ошибками все равно создаются</a></li><li class=menu-item><a href=#%d1%83%d0%b4%d0%b0%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5-%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8 class=menu-link>Удаление функции</a></li><li class=menu-item><a href=#%d0%bb%d0%be%d0%ba%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b5-%d0%bf%d0%b5%d1%80%d0%b5%d0%bc%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5 class=menu-link>Локальные переменные</a></li><li class=menu-item><a href=#%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b9-%d0%b2-sql-%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d0%b0%d1%85 class=menu-link>Использование функций в SQL запросах</a></li></ul></nav></div><h2 id=какую-проблему-помогают-решить-функции>Какую проблему помогают решить функции</h2><p>Общее описание функций уже было дано в предыдущей части, добавим лишь
то, что функции - это один из способов сделать наш код более простым,
понятным, компактным, а также избежать повторного написания однотипного
кода.</p><h2 id=пример-создания-простой-функции>Пример создания простой функции</h2><p>Предположим, что мы работаем над системой, в которой часто приходится
считать размер скидок в зависимости от стоимости купленного товара.
Размер скидки интересует нас с точностью до двух знаков после запятой.</p><p>Вот так может выглядеть код для вычисления нашей скидки:</p><pre><code>declare
    -- Сумма скидки
    l_discount number;
    -- Стоимость товара
    l_price number := 350;
begin
    l_discount := round(l_price * (10 / 100), 2);
    
    dbms_output.put_line(l_discount);
end;
/
</code></pre><p>В результате на экран выведется размер скидки - 35.</p><p>Мы посчитали размер скидки по одному товару. А что, если нам нужно
посчитать скидку по трем товарам в отдельности? Пишем код:</p><pre><code>declare
    l_discount_1 number;
    l_discount_2 number;
    l_discount_3 number;
    l_price_1 number := 350;
    l_price_2 number := 100;
    l_price_3 number := 25;
begin
    l_discount_1 := round(l_price_1 * (10 / 100), 2);
    l_discount_2 := round(l_price_2 * (10 / 100), 2);
    l_discount_3 := round(l_price_3 * (10 / 100), 2);

    dbms_output.put_line(l_discount_1);
    dbms_output.put_line(l_discount_2);
    dbms_output.put_line(l_discount_3);
end;
/
</code></pre><p>Вывод:</p><pre><code>35
10
2.5
</code></pre><p>Может показаться, что все выглядит вполне себе хорошо - необходимая
логика реализована, в чем проблема?</p><p>Представим, что в какой-то момент начальство говорит вам о том, что
размер скидки должен округляться до одного знака после запятой, а не до
двух? Нам придется изменить это в трех местах. То же относится и к
размеру скидки - что, если в определенный момент времени скидка станет
не 10, а 20 или 30 процентов?</p><p>Помимо всего прочего, код выше выглядит сложно, без необходимой на то
причины. Мы могли бы создать функцию, которая будет считать размер этой
скидки и возвращать её нам:</p><pre><code>create function getDiscount(
    pprice number
) return number
is
begin
    return round(pprice * (10 / 100), 2);
end;
/
</code></pre><p>Если запустить код выше, то в текущей схеме БД станет доступна функция
getDiscount. Используем ее, чтобы модифицировать предыдущий пример:</p><pre><code>declare
    l_discount_1 number;
    l_discount_2 number;
    l_discount_3 number;
    l_price_1 number := 350;
    l_price_2 number := 100;
    l_price_3 number := 25;
begin
    l_discount_1 := getDiscount(l_price_1);
    l_discount_2 := getDiscount(l_price_2);
    l_discount_3 := getDiscount(l_price_3);

    dbms_output.put_line(l_discount_1);
    dbms_output.put_line(l_discount_2);
    dbms_output.put_line(l_discount_3);
end;
/
</code></pre><p>Вывод:</p><pre><code>35
10
2.5
</code></pre><p>Теперь, чтобы сделать изменение в логике подсчета скидки, это нужно
сделать всего в одном месте, и сразу же размер скидки будет считаться по
новым правилам.</p><p>По-умолчанию, при попытке создать функцию с именем, которое уже
существует в текущей схеме, Oracle выдаст ошибку. Для того, чтобы этого
не возникало, при описании функции используется конструкция
<code>create or replace</code>.</p><p>Рассмотрим подробнее синтаксис создания функции в PL/SQL.</p><pre><code>-- Используем create or replace,
-- чтобы заменить предыдущую функцию
-- с таким же именем на новую
create or replace function funcName(
    param1 number
) return number
is
begin
    return 1;
end;
/
</code></pre><p>Основные элементы которые нужно указать при создани функции это:</p><ul><li>Имя функции</li><li>Параметры(могут отсутствовать)</li><li>Тип возвращаемого значения</li><li>Тело функции</li><li>Команда Return</li></ul><p><img src=/img/plsql/function_structure.png alt></p><p>Вообще, существует большое количество дополнительных синтаксических
конструкций при создании функций, как например указание того, что
функция является табличной или детерминированной, но на данном этапе мы
не будем их рассматривать, так как они используются лишь в специфичных
случаях.</p><p>Выше мы создали функцию с именем funcName, которая принимает один
параметр с типом number и возвращает значение типа number( в нашем
примере это всегда число 1).</p><p>Если параметров несколько, они перечисляются через запятую, например:</p><pre><code>create function funcName(
    p1 number,
    p2 varchar2
) return boolean
is
begin
    return false;
end;  
/
</code></pre><p>Команда return используется для того, чтобы вернуть значение из функции.
Сразу после этого работа функции завершается, то есть код, который
указан после <code>return</code>, до которого дошло выполнение, никогда не будет
вызван:</p><pre><code>create function funcName() return bool
is
begin
    return false;
    -- Функция всегда будет возвращать False,
    -- следующий return никогда не будет выполнен
    return true;
end;
/
</code></pre><p>Следует обратить внимание, что при описании параметров функции мы не
указываем размерность типов.</p><p>Следующее описание функции вызовет ошибку:</p><pre><code>create function funcName(
    p1 number(10,2),
    p2 varchar2(100 char)
) return boolean
is
begin
    return false;
end;
/
</code></pre><p>Функции могут быть и без аргументов:</p><pre><code>-- Возвращает процент скидки
create function discValue() return number is
begin
    return 10;
end;
/
</code></pre><h2 id=функции-с-ошибками-все-равно-создаются>Функции с ошибками все равно создаются</h2><p>Если мы попытаемся создать функцию с ошибкой, то она все равно создастся
в схеме БД, но использовать ее будет нельзя, т.к. она будет иметь статус
invalid.</p><p>Создадим следующую функцию:</p><pre><code>create function invalidFunc() return number is
begin
    return false;
end;
/
</code></pre><p>Здесь у нас ошибка, т.к. функция должна возвращать тип number, а мы
возвращаем значение типа boolean. Oracle выдаст что-нибудь в этом духе:</p><pre><code>Errors: FUNCTION INVALIDFUNC
Line/Col: 1/22 PLS-00103: Encountered the symbol &quot;)&quot; when
expecting one of the following:

   &lt;an identifier&gt; &lt;a double-quoted delimited-identifier&gt;
   current delete exists prior
</code></pre><p>Ok, пробуем создать функцию без ошибок:</p><pre><code>create function invalidFunc() return number is
begin
    return 1;
end;
/
</code></pre><p>И в итоге получаем сообщение
<code>ORA-00955: name is already used by an existing object</code>, что означает
что в схеме уже есть объект с таким именем. В нашем случае - это функция
<code>invalidFunc</code>, которая была создана во время предыдущей попытки.</p><p>Поэтому, чтобы заменить предыдущий вариант функции на новый, нужно
использовать конструкцию <code>create or replace</code>.</p><h2 id=удаление-функции>Удаление функции</h2><p>Чтобы удалить функцию из схемы, используется команда <code>drop function</code>:</p><pre><code>drop function invalidFunc;
</code></pre><h2 id=локальные-переменные>Локальные переменные</h2><p>Не всегда функции бывают такими простыми, что их логика помещается в
одну команду <code>return</code>.</p><p>Для реализации более сложной бизнес-логики или для улучшения
&ldquo;читаемости&rdquo; кода лучше можно использовать локальные переменные фукнции</p><ul><li>переменные, которые доступны для использования только внутри функции и
нигде больше. Они объявляются между ключевым словом <code>IS</code> и <code>BEGIN</code>.</li></ul><p>Попробуем переписать нашу функцию <code>getDiscount</code> с использованием
локальных переменных:</p><pre><code>create or replace function getDiscount(
    pprice number
) return number
is
    discPerc constant number := 10;
    discount number;
begin
    discount := round(pprice * (discPerc / 100), 2);

    return discount;
end;
/
</code></pre><h2 id=использование-функций-в-sql-запросах>Использование функций в SQL запросах</h2><p>Функции PL/SQL можно использовать в SQL запросах. Для демонстрации этого
создадим таблицу с товарами и ценами:</p><pre><code>create table products(
    id number primary key,
    name varchar2(300 char),
    price number
);

insert into products
values(1, 'Фотоаппарат', 1340);

insert into products
values(2, 'Клавиатура', 55);

insert into products
values(3, 'Планшет', 800);
</code></pre><p>Теперь получим список товаров и размер скидки на них:</p><pre><code>select name, price, getDiscount(price) disc
from products
</code></pre><p>Результат:</p><pre><code>NAME         PRICE  DISC
=========================
Фотоаппарат | 1340 | 134
Клавиатура  | 55   | 5.5
Планшет     | 800  | 80
=========================
</code></pre><nav class="pagination mb-3"><ul class=pagination-list><li class=pagination-item><a href=http://orasql.ru/plsql/basics/plsql_schema/ class="pagination-link pagination-prev">&lt; Схема БД. Её объекты</a></li><li class="pagination-item ml-auto"><a href=http://orasql.ru/plsql/basics/plsql_procedures/ class="pagination-link pagination-next">Процедуры в PL/SQL ></a></li></ul></nav></div></div></div></main><footer class="footer b-dark-low b-top"><div class="footer-container container centered edges"><div class="footer-body mt-10"><nav class="nav nav-muted nav-menu-sm"><ul class=nav-list><li class=nav-item><a href=/ class=nav-link>Orasql.ru</a></li><li class=nav-item><a href=/ class=nav-link>Учебник</a></li><li class=nav-item><p class="text-medium text-moderated">Email: orasqlru@gmail.com</p></li></ul></nav></div><div class="footer-copy mt-6 pt-6 b-dark-7 b-top"><p class="text-medium text-moderated">© Orasql.ru<br>2019-2022</p></div></div></footer></body></html>
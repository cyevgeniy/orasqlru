<!--{
    "Title": "Псевдостолбцы в Oracle",
    "Links": {
        "Prev": {
            "Url": "../virtualcolumns/index.html",
            "Title": "Виртуальные колонки"
        },
        "Next": {
            "Url": "../transactions/index.html",
            "Title": "Введение в транзакции"
        }
        }
}-->

<div class="doc-head mb-4 container-10">
    <h5 class="heading-micro heading-muted">Объекты БД</h5>
    <h1 class="heading-huge heading-heavy">Псевдостолбцы в Oracle</h1>
</div>

<div class="doc-toc mt-6 mb-6">
    <nav class="menu menu-underline menu-medium menu-numbered">
        <ul class="menu-list">
        <li class="menu-item"><a href="#rownum" class="menu-link"><code>ROWNUM</code></a></li>
        <li class="menu-item"><a href="#rowid" class="menu-link"><code>ROWID</code></a></li>
        <li class="menu-item"><a href="#level" class="menu-link"><code>LEVEL</code></a></li>
        </ul>
    </nav>
</div>


<p>
К псевдостолбцам можно относиться как к обычным колонкам в таблице,
за тем лишь исключением, что данные, которые они представляют,
в таблице не хранятся.
</p>

<p>
Некоторые псевдостолбцы доступны только в определенном контексте,
например, лишь при использовании рекурсивных запросов.
</p>

<p>
Мы рассмотрим не все псевдостолбцы, доступны в Oracle, а лишь самые основные и
часто используемые. Полный их список и описание можно почитать
в <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14200/pseudocolumns.htm">докумениации</a>.
</p>

<p>
Мы будем использовать таблицу <code>dishes</code>, которая создается в части про
<a href="../comparison/index.html">операторы сравнения</a>.
</p>

<h2 id="rownum">ROWNUM</h2>

<p>
Данный псевдостолбец возвращает порядковый номер, под которым Oracle
выбирает строку из таблицы. Для первой строки значение <code>ROWNUM</code> будет равно 1,
для второй - 2, и т.д.
</p>

<p>
Один из классических примеров использования <code>ROWNUM</code> - ограничение количества
получаемых строк из таблицы:
</p>

<pre>
select d.*
from dishes d
where rownum < 3
</pre>


<img src="../../img/11_pseudocolumns/rownum_less_3.png">

<p>
Если в запросе используется сортировка, то она может изменить
порядок строк. Т.е. строка из таблицы могла получаться первой, и ей мог
быть присвоен rownum = 1, но после того, как все строки были получены,
они были отсортированы в другом порядке:
</p>

<pre>
select d.*, rownum
from dishes d
where rownum < 6
order by price asc
</pre>


<img src="../../img/11_pseudocolumns/rownum_order_by.png">

<p>
Что же делать, если мы хотим пронумеровать наши строки начиная от 1 таким
образом, чтобы у самого дешевого блюда был номер 1, у более дорогого - 2 и т.п.?
</p>

<p>
Для этого можно использовать <a href="../subqueries/index.html">подзапросы</a>:
</p>

<pre>
select dishes_ordered.*, rownum
from (
  select d.*
  from dishes d
  order by price asc
) dishes_ordered
</pre>

<img src="../../img/11_pseudocolumns/rownum_ordered.png">

<p>
Теперь все будет работать, т.к. сортировка данных была произведена в
подзапросе еще *до того, как данные будут получаться внешним запросом*, а
значит и до того, как каждой строке будет присваиваться  значение
<code>ROWNUM</code>.
</p>

<p>
Следует отметить, что использование оператора "&gt;" с <code>ROWNUM</code> не имеет смысла.
Рассмотрим это на примере:
</p>


<pre>
select d.*
from dishes d
where rownum > 3
</pre>


<p>
Этот запрос ничего не выведет, несмотря на то, что строк в таблице больше трех.
Все потому, что <code>rownum</code> хранит в себе номер строки, под которым Oracle
получает ее из таблицы или соединения. В примере выше у первой строки(какой
бы она не была, она все равно будет первой) значение <code>rownum</code> будет равно 1.
Это значит, что условие <code>rownum > 3</code> будет ложным, и строка не будет добавлена
в выборку. Следующая строка опять будет иметь <code>rownum = 1</code>, что опять приведет
значение условия в False, и так будет для всех строк из таблицы <code>dishes</code>.
</p>

<h3>Top-N query</h3>

<p>
Получим топ-3 блюда по рейтингу с помощью <code>rownum</code>:
</p>

<pre>
select rt.name,
       rt.price,
       rt.rating,
       ROWNUM
from (
  select d.*
  from dishes d
  order by d.rating desc nulls last
) rt
where ROWNUM <= 3
</pre>

<img src="../../img/11_pseudocolumns/rownum_topn.png">

<p>
Подобного рода запросы относятся к так называемым "top-N queries", т.е.
они получают часть данных, основываясь на каком-либо критерии сортировки (
в данном случае это рейтинг блюд).
</p>

<h2 id="rowid"> ROWID</h2>

<p>
<code>ROWID</code> содержит в себе адрес строки в таблице. На практике он используется
не часто, но иногда его значение может понадобиться сторонним библиотекам.
</p>

<p>
Сам <code>rowid</code> уникально идентифицирует определенную строку в таблице, но
это не означает, что <code>rowid</code> уникален в пределах всей базы данных.
</p>

<p>
Значение <code>rowid</code> нельзя использовать для того, чтобы ссылаться на определенную
строку в таблице, т.к. оно может измениться.
</p>

<p>
Для примера просто получим все строки из таблицы <code>dishes</code> с их <code>rowid</code>:
</p>

<pre>
select rowid, d.name
from dishes d
</pre>


<img src="../../img/11_pseudocolumns/rowid.png">

<h2 id="level"> LEVEL </h2>

<p>
Данный псевдостолбец доступен только в рекурсивных запросах. Подробнее про
него можно почитать в части про <a href="../recursive/index.html">рекурсивные запросы</a>.
</p>

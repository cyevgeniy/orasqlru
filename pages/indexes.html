<!--{
    "Title": "Индексы",
    "Links": {
        "Next": {
            "Url": "../virtualcolumns/index.html",
            "Title": "Виртуальные колонки"
        },
        "Prev": {
            "Url": "../views/index.html",
            "Title": "Представления"
        }
        }
}-->

<div class="doc-head mb-4 container-10">
    <h5 class="heading-micro heading-muted">Объекты БД</h5>
    <h1 class="heading-huge heading-heavy">Индексы</h1>
</div>

<div class="doc-toc mt-6 mb-6">
    <nav class="menu menu-underline menu-medium menu-numbered">
        <ul class="menu-list">
        <li class="menu-item"><a href="#whatisindexes" class="menu-link">Что такое индексы</a></li>
        <li class="menu-item"><a href="#createindex" class="menu-link">Создание индекса</a></li>
        <li class="menu-item"><a href="#deleteindex" class="menu-link">Удаление индекса</a></li>
        <li class="menu-item"><a href="#multiplecolumns" class="menu-link">Составные индексы</a></li>
        <li class="menu-item"><a href="#uniqueindexes" class="menu-link">Уникальные индексы</a></li>
        <li class="menu-item"><a href="#whentocreateindex" class="menu-link">Когда нужно создавать индекс</a></li>
        </ul>
    </nav>
</div>

<h2 id="whatisindexes"> Что такое индексы </h2>

<p>
Индексы - это специальные объекты в БД, которые
хранят в себе записи для каждого встречающегося в индексированной колонке
значения. Внутреннее устройство индексов таково, что они позволяют
быстро находить строки в таблице, содержащие определенные значения.
</p>

<p>
Чтобы лучше понять как работает индекс и для чего он нужен, представьте телефонный
справочник, в котором абоненты расположены в случайном порядке.
Чтобы найти нужного абонента, придется просматривать все записи в справочнике
по порядку до тех пор, пока не встретится нужный. Но если расположить всех
абонентов в алфавитном порядке, по адресам и т.д, то времени на поиски
будет затрачено гораздо меньше. Для того же и используются индексы в БД - 
чтобы уменьшить время на поиски нужных записей в таблице.
</p>

<p>
То есть индексы - это отдельные объекты в БД, которые используются
для того, чтобы ускорить поиск данных. В Oracle существует несколько типов
индексов, далее здесь будут рассматриваться так называемые "B-tree" индексы.
Это "классический" тип индексов, который используется на практике, и часто,
когда говорят слово "индекс", то подразумевают именно его.
</p>


<h2 id="createindex">Создание индекса</h2>

<p>
Создадим индекс на колонку <code>dept_id</code> в таблице <code>employees</code>:
</p>

<pre>
create index employee_dept_id_idx on employees(dept_id);
</pre>


<p>
Здесь <code>employee_dept_id_idx</code> - это имя индекса, оно могло быть любым.
</p>

<div class="alert alert-info">
<p>
На длину имен индексов также действует ограничение в 30 символов.
</p>
</div>

<div class="alert alert-info">
<p>
При создании первичного или уникального ключа в таблице
Oracle создает индексы на эти колонки автоматически.
</p>
</div>

<h2 id="deleteindex">Удаление индекса</h2>

<p>
Индексы удаляются по своим именам. Удалим индекс <code>employee_dept_id_idx</code>:
</p>

<pre>
drop index employee_dept_id_idx;
</pre>


<h2 id="multiplecolumns">Составные индексы</h2>

<p>
Индексы могут создаваться на несколько колонок. Такие индексы
называются составными.
</p>


<pre>
create index employee_name_idx on employees(first_name, last_name);
</pre>


<p>
Составные индексы можно добавлять тогда, когда в таблице ищут
данные сразу по нескольким колонкам. Порядок колонок
в составном индексе важен. Однозначного правила, которое
бы работало всегда, нет, но чаще всего следует добавлять
колонки в индекс в порядке:
</p>

<ul>
<li>Частоты их использования в запросах</li>
<li>Количества уникальных значений, содержащихся в колонке.</li>
</ul>

<p>
Рассмотрим это на примере. Если у нас есть таблица <code>employees</code>,
из которой часто получают данные по фамилии и коду должности,
т.е. из таблицы часто запрашивают данные в подобном виде:
</p>

<pre>
select *
from employees e
where e.emp_name = 'Евгений'
and e.job_code = 21
</pre>


<p>
То в таком случае можно попробовать добавить составной индекс,
состоящий из колонок <code>emp_name</code> и <code>job_code</code>:
</p>

<pre>
create index emp_name_job_id_idx on employees(emp_name, job_id);
</pre>


<p>
Порядок колонок в индексе не обязательно должен совпадать в порядке
встречи колонок в условии запроса; Исходим мы здесь из того
предположения, что:
</p>

<ol>
<li>По имени будут искать гораздо чаще</li>
<li>Количество уникальных имен в таблице больше, чем количество
   уникальных должностей.</li>
</ol>

<p>
До версии 9i порядок колонок в индексе был более важен, т.к.
обязательным условием использования индекса было обращение в
запросе к колонке, которая является первой в индексе. В нашем
случае, если бы мы написали запрос следующим образом:
</p>

<pre>
select *
from employees
where job_id = 10
</pre>


<p>
индекс не использовался бы, т.к. в запросе нет фильтрации
по колонке <code>emp_name</code>, которая идет первой в составном индексе.
</p>

<h3>Index skip scan</h3>

<p>
Начиная с версии 9i в Oracle появилась возможность
использовать составной индекс, даже если его лидирующая
колонка не используется в запросе.
</p>

<p>
Index skip scan может использоваться тогда, когда
количество уникальных значений лидирующей колонки
индекса относительно невелико. Опять же, решение
об использовании или неиспользовании принимает
оптимизатор Oracle.
</p>

<div class="alert alert-error">
<p>
По-прежнему, лучше стараться создавать
составные индексы таким образом, чтобы
лидирующая колонка использовалась
чаще всего, так как наличие возможности
использования index scip scan вовсе не означает,
что он будет использован всегда.
</p>
</div>


<h3>Зачем использовать составные индексы</h3>

<ul>
<li> Могут сократить кол-во записей за счет комбинирования колонок</li>
<li> Если выбираются только колонки из индекса, то это сократит количество
операций чтения, т.к. в этом  случае данные будут выбраны из индекса без обращения
к таблице.</li>
</ul>

<h2 id="uniqueindexes">Уникальные индексы</h2>

<p>
Уникальные индексы гарантируют, что
значения колонок, входящих в него, будут
уникальны. В этом смысле они похожи на
<a href="../uniquekeys/index.html">уникальные ключи</a> и 
<a href="../primarykeys/index.html">первичные ключи</a>.
Отличие в том, что индекс - это объект в базе данных,
задача которого - обеспечить быстрый поиск данных. Ключи же
являются отражением бизнес-требований к приложению. Мы создаем
уникальный ключ не для ускорения поиска, а для того, чтобы обеспечить
уникальность данных, потому что этого требует задача.
</p>

<div class="alert alert-info">
<p>
Ключи могут использовать индексы для реализации
своих задач, например, первичный ключ может создать
(или  использовать уже имеющийся) индекс.
</p>
</div>


Уникальные индексы создаются следующим образом:

<pre>
-- Создать уникальный индекс на колонку
-- id таблицы employees
create unique index emp_uk_idx on
employees(id);
</pre>

<h2 id="whentocreateindex">Когда нужно создавать индекс</h2>

<p>
Однозначно ответить на этот вопрос нельзя,
т.к. наличие индекса не означает, что он
будет использоваться. Решение о том, использовать
индекс или нет, принимает оптимизатор Oracle.
</p>

<p>
В общем случае, можно придерживаться следующих
рекомендаций:
</p>

<ul>
<li> Если колонка часто используется в <code>WHERE</code></li>
<li> Если колонка  содержит большое количество
  уникальных значений по отношению к общему количеству
  строк в таблице.</li>
</ul>


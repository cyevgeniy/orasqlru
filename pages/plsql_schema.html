<!--{
    "Title": "Схема БД. Её объекты",
    "Links": {
        "Next": {
            "Url": "../plsql_functions/index.html",
            "Title": "Функции"
        },
        "Prev": {
            "Url": "../plsql_ifelse/index.html",
            "Title": "Условное ветвление. If...else"
        }
        }
}-->

<div class="doc-head mb-4 container-10">
    <h5 class="heading-micro heading-muted">Основы PL/SQL</h5>
    <h1 class="heading-huge heading-heavy">Схема БД. Её объекты </h1>
</div>

<div class="doc-toc mt-6 mb-6">
    <nav class="menu menu-underline menu-medium menu-numbered">
        <ul class="menu-list">
        <li class="menu-item"><a href="#whatisschema" class="menu-link">Понятие схемы БД</a></li>
        <li class="menu-item"><a href="#functions" class="menu-link">Функции</a></li>
        <li class="menu-item"><a href="#procedures" class="menu-link">Процедуры</a></li>
        <li class="menu-item"><a href="#procvsfunc" class="menu-link">Процедура или функция</a></li>
        <li class="menu-item"><a href="#packages" class="menu-link">Пакеты</a></li>
        <li class="menu-item"><a href="#triggers" class="menu-link">Триггеры</a></li>


        </ul>
    </nav>
</div>

<h2 id="whatisschema">Понятие схемы БД</h2>

<p>
<b>Схема</b> - это совокупность всех объектов некоего пользователя,
называемого владельцем схемы.
Сюда входят таблицы, индексы, представления, триггеры, всё-всё-всё.
То есть мы должны понимать, что когда мы говорим про функции
или процедуры в PL/SQL, они находятся внутри схемы.
</p>

<div class="alert alert-info">
<p>
Мы не будем перечислять все возможные типы объектов, которые могут
храниться в схеме, перечислим лишь несколько. Все нижеописанные объекты
будут рассмотрены по отдельности далее в учебнике, здесь будет дана 
информация для первичного ознакомления с ними.
</p>
</div>

<h2 id="functions">Функции</h2>

<p>
Функции представляют собой именованные блоки кода, которые
можно вызывать повторно. Отличительной особенностью
функций является то, что по своей натуре они должны возвращать
некое значение.
</p>

<p>
Простой пример - функция сложения двух чисел <code>Mysum</code>.
Вот пример того, как она могла бы быть описана:
</p>
<pre>
<code>function Mysum(a number,
    b number
) return number
is
begin
    return a + b;
end;</code></pre>

<p>
И далее, везде, где мы хотим получить сумму двух чисел,
мы можем использовать уже созданную функцию:
</p>

<pre>
<code>begin
	a := sum(5, 10);
	b := sum(10, a);
	-- Функции могут использоваться в качестве
	-- параметров других функций
	c := sum(sum(a, b), 20);
end;</code></pre>

<p>
Также, функции pl/sql можно использовать в обычных
SQL запросах, например вот так:
</p>

<pre>
<code>select Mysum(l.age, 2) new_age
from users l</code>
</pre>

<h2 id="procedures">Процедуры</h2>

<p>
Процедуры, так же как и функции, представляют собой
именованные блоки кода, которые можно(и нужно) использовать
повторно. Отличаются от функций тем, что вызов процедуры
не возвращает значение, как функция, но несмотря на это,
через процедуры можно возвращать значения - через так называемые
<code>out</code> параметры.
</p>

<div class="alert alert-error">
<p>
Процедуры нельзя использовать в SQL запросах.
</p>
</div>

<h2 id="procvsfunc">Процедура или функция</h2>

<p>
Процедуры очень похожи на функции, и не
всегда можно понять, что же использовать.
Тем не менее, в большинстве случаев,
рекомендуется использовать функции лишь
для того, чтобы что-то вычислять и возвращать
это значение, но не изменять состояние данных
в БД. Процедуры же, наоборот, рекомендуется
использовать в тех случаях, когда они изменяют
данные в БД.
</p>

<p>
Вышеупомянутая функция <code>Mysum</code>,
например, ничего не изменяет, она лишь
считает сумму двух чисел и возвращает ее.
</p>

<p>
Какой код можно было бы использовать в процедуре?
Ну, например, процедура добавления нового пользователя
в систему. Добавление нового пользователя приводит
к тому, что в таблицу(или даже несколько) БД будет
добавлена запись, некоторые, возможно будут обновлены
и т.д.
</p>

<p>
Итого, <b>лучше создавать функцию</b>, если:
</p>
<ul>
<li>Она только производит вычисления</li>
<li>Она только возвращает данные, хранящиеся в БД</li>
</ul>
<p>
<b>Лучше создавать процедуру</b>, если:
</p>

<ul>
<li>Данные в БД будут изменяться</li>
<li>Данные не будут изменяться, но мы не нуждаемся
в возвращении значения после ее вызова</li>
</ul>

<p>
Конечно, эти советы не являются обязательными, и
от них вполне можно отступаться, более того, достаточно
часто в коде PL/SQL можно встретить функции, которые
изменяют данные, например, подобного рода:
</p>

<pre>
<code>-- добавить пользователя и вернуть его id
function addUser(login varchar2) return number;</code>
</pre>

<p>
Здесь функция <code>addUser</code> добавляет нового
пользователя в систему и сразу возвращает его id.
</p>
<p>
Главное, пожалуй, здесь то, чтобы действия, производимые
подпрограммами, которые вы пишете, должны быть понятными;
достичь этого во многом помогают правильные наименования,
как в примере выше - вот если бы функция называлась бы
просто <code>user</code>, было бы гораздо сложнее понять,
что она делает.
</p>

<div class="alert alert-info">
<p>
Процедуры и функции, которые хранятся в БД, еще часто
называют хранимыми процедурами и хранимыми функциями.
Тем не менее, чаще всего используют термин "хранимая
процедура" для обозначения как процедур, так и функций.
</p>
</div>

<h2 id="packages">Пакеты</h2>

<p>
Пакеты - это такие объекты, которые позволяют сгруппировать
набор функций, процедур, констант, переменных и типов
в одном модуле. Они не только помогают улучшить организацию кода, но
и позволяют реализовать инкапсуляцию - т.е. скрыть внутреннюю
реализацию своего функционала. Достигается это благодаря тому, что
пакет имеет <i>спецификацию</i> и <i>тело</i>. Для использования
внутри схемы доступны всё, что описано в спецификации пакета, но все,
что описано в теле пакета и не описано в спецификации,
нельзя использовать вне тела пакета.
</p> 
<p>
Приведем простой пример: предположим, у нас есть пакет
под названием <code>pckUser</code>. В спецификации пакета
даны описания функций добавления, удаления и редактирования
пользователя:
</p>
<pre>
<code>procedure insUser(login varchar2);
procedure updUser(id number, login varchar2);
procedure delUser(id number);</code>
</pre>

<p>
Эти три процедуры будут доступны внутри схемы, и вызвать
их можно будет подобным образом:
</p>

<pre>
<code>begin
    pckUser.insUser('username');
end;</code></pre> 

<p>
Схематично структура пакета может выглядеть подобным
образом:
</p>

<img src="../../img/plsql/package_structure.png">

<p>
"Снаружи" из пакета доступны только три вышеупомянутые
процедуры. Но внутри пакета, помимо реализации публичных
процедур, также созданы еще две функции - <code>isLoginExist</code>
и <code>updUserStatus</code>. Они могут использоваться как
вспомогательные функции/процедуры внутри других подпрограммах пакета,
но не будут доступны для вызова вне тела пакета.
</p>

<h2 id="triggers">Триггеры</h2>

<p>
Триггеры - это специальные процедуры, которые
запускаются автоматически при определенных действиях
с таблицами.
</p>

<p>
То есть, когда мы запускаем, к примеру, следующий
запрос:
</p>

<pre>
<code>update users
set is_active = 0
where id = 10</code>
</pre>

<p>
В базе данных может <i>автоматически</i> запуститься
триггер, который будет при деактивации пользователя
заполнять значение в колонке с датой деактивации.
</p>

<p>
Триггеры могут выполняться до или после вставки, изменения или
удаления данных в таблице. Существуют и более сложные виды
триггеров, но они будут рассматриваться в отдельной
теме, посвященной триггерам.
</p>

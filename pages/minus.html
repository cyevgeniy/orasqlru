<!--{
    "Title": "Разница запросов. MINUS",
    "Links": {
        "Next": {
            "Url": "../intersect/index.html",
            "Title": "Пересечение. INTERSECT"
        },
        "Prev": {
            "Url": "../unions/index.html",
            "Title": "Объединение запросов. UNION"
        }
        }
}-->

<div class="doc-head mb-4 container-10">
    <h5 class="heading-micro heading-muted">Работа с множествами</h5>
    <h1 class="heading-huge heading-heavy">Разница запросов. MINUS</h1>
</div>


<p>
Подготовим тестовые данные:
</p>

<pre>
create table cars(
    car_id number not null,
    car_model varchar2(100) not null,
    release_year number
);

create table car_offers(
    car_model varchar2(100) not null,
    release_year number
);

insert into cars
values(1, 'Volkswagen passat', 1998);

insert into cars
values(2, 'Volkswagen passat', 1998);

insert into cars
values(3, 'Mersedes SL', 2010);

insert into cars
values(4, 'Lexus S300', 2005);

insert into cars
values(5, 'Mersedes SL', 2008);

insert into car_offers
values('Lexus S300', 2010);

insert into car_offers
values('Tesla', 2017);

insert into car_offers
values('Volkswagen passat', 1998);

insert into car_offers
values('Volkswagen passat', 2003);
</pre>

<p>
Посмотрим на данные в таблицах:
</p>

<p>Таблица <code>cars</code></p>

<img src="../../img/7_unions/minus_cars.png">

<p>Таблица <code>car_offers</code></p>

<img src="../../img/7_unions/minus_car_offers.png">

<p>
Получим список предлагаемых нам моделей
автомобилей, которых нет среди нашего автопарка.
Для этого будем использовать оператор <code>MINUS</code>,
который возвращает уникальные строки из первого запроса,
которых нет во втором запросе:
</p>

<pre>
select car_model
from car_offers

MINUS

select car_model
from cars
</pre>

<img src="../../img/7_unions/minus_car_model_result.png">

<p>
Если искать только отсутствующие у нас марки авто,
то найдется лишь одна модель, которой нет у нас - "Tesla".
</p>

<p>
Теперь получим предложения автомобилей, у которых либо год,
либо модель не совпадают с теми авто, что есть у нас:
</p>

<pre>
select car_model, release_year
from car_offers

MINUS

select car_model, release_year
from cars
</pre>


<img src="../../img/7_unions/minus_car_model_year_result.png">

<p>
Типы данных в колонках и их количество в
каждом из запросов
должны совпадать.
</p>


<p>
Если мы в первом запросе поменяем местами колонки,
то запрос не выполнится и мы получим ошибку
<code>ORA-01790: expression must have same datatype as corresponding expression</code>:
</p>

<pre>
-- Ошибка, типы данных возвращаемых колонок  в 
-- обоих запросах должны совпадать
select release_year, car_model
from car_offers

MINUS

select car_model, release_year
from cars
</pre>

<p>
Если запросы возвращают неодинаковое количество колонок,
при выполнении запроса получим ошибку
<code>ORA-01789: query block has incorrect number of result columns</code>:
</p>

<pre>
-- Ошибка, запросы должны возвращать
-- одинаковое количество колонок
select release_year
from car_offers

MINUS

select car_model, release_year
from cars
</pre>

<div class="alert alert-info">
<p>
MINUS возвращает уникальные строки,
которые отсутствуют во втором запросе.
</p>
</div>


<p>
Разберем это на примере. Для начала
удалим из таблицы <code>car_offers</code> модели
Volkswagen passat:
</p>

<pre>
delete
from car_offers
where car_model = 'Volkswagen passat'
</pre>


<p>
Теперь данные в таблице <code>car_offers</code>
выглядят вот так:
</p>

<img src="../../img/7_unions/minus_car_offers_without_passat.png">

<p>
Теперь получим список моделей авто, которые есть у нас, но
отсутствуют в списке предложений:
</p>

<pre>
select car_model, release_year
from cars

MINUS

select car_model, release_year
from car_offers
</pre>

<img src="../../img/7_unions/minus_unique_passat.png">

<p>
В результате мы видим всего одну строку с моделью
Volkswagen passat 1998 года, несмотря на то, что
в таблице <code>cars</code> таких записей две. Как было сказано,
это произошло потому, что оператор <code>MINUS</code> удаляет дубликаты
и возвращает только уникальные строки.
</p>